# RPC Flow with Discovery Diagram

This diagram shows how RPC discovery and type-safe RPC calls work.

```mermaid
graph TB
    subgraph Scenario1["Scenario 1: RPC Discovery"]
        S1_1[Client App:<br/>rpc.call'listall']
        S1_2[RPC Class:<br/>Send RPC_REQUEST<br/>method=listall]
        S1_3[Server:<br/>Receive request]
        S1_4[RPC Registry:<br/>Get all methods]
        S1_5[Server:<br/>methods list]
        S1_6[RPC Class:<br/>Parse response]
        S1_7[Client App:<br/>Receive list<br/>of methods ✓]
        
        S1_1 --> S1_2 --> S1_3 --> S1_4 --> S1_5 --> S1_6 --> S1_7
    end
    
    subgraph Scenario2["Scenario 2: Type-Safe RPC Call"]
        S2_1[Client App:<br/>rpc.call'calculate'<br/>args=dataa=10, b=20]
        S2_2[RPC Class:<br/>Build params dict]
        S2_3[RPC Class:<br/>Serialize with<br/>Pydantic]
        S2_4[Client Connection:<br/>RPC_REQUEST<br/>corr_id=456]
        S2_5[Server:<br/>Receive request]
        S2_6[RPC Registry:<br/>Find handler<br/>for 'calculate']
        S2_7[RPC Handler:<br/>Extract type hints]
        S2_8[RPC Handler:<br/>Validate params<br/>with Pydantic]
        S2_9{Valid?}
        S2_10[RPC Handler:<br/>Execute function<br/>result = 30]
        S2_11[RPC Handler:<br/>Wrap with<br/>Response]
        S2_12[Server:<br/>RPC_RESPONSE<br/>corr_id=456]
        S2_13[Client:<br/>Match corr_id]
        S2_14[RPC Class:<br/>Parse with<br/>Pydantic]
        S2_15[RPC Class:<br/>Create typed object]
        S2_16[Client App:<br/>result.result = 30<br/>Already parsed! ✓]
        
        S2_1 --> S2_2 --> S2_3 --> S2_4 --> S2_5 --> S2_6 --> S2_7 --> S2_8 --> S2_9
        S2_9 -->|Yes| S2_10 --> S2_11 --> S2_12 --> S2_13 --> S2_14 --> S2_15 --> S2_16
    end
    
    subgraph Scenario3["Scenario 3: Method Not Found Error"]
        S3_1[Client App:<br/>rpc.call'unknown_method']
        S3_2[RPC Class:<br/>Send RPC_REQUEST]
        S3_3[Server:<br/>Receive request]
        S3_4[RPC Registry:<br/>Find handler]
        S3_5{Handler<br/>exists?}
        S3_6[Server:<br/>Create Error<br/>'Method not found']
        S3_7[Server:<br/>RPC_ERROR<br/>corr_id=789]
        S3_8[RPC Class:<br/>Parse error]
        S3_9[Client App:<br/>Raise RPCError<br/>Exception ✗]
        
        S3_1 --> S3_2 --> S3_3 --> S3_4 --> S3_5
        S3_5 -->|No| S3_6 --> S3_7 --> S3_8 --> S3_9
    end
    
    subgraph Scenario4["Scenario 4: Validation Error"]
        S4_1[Client App:<br/>rpc.call'calculate'<br/>missing params]
        S4_2[RPC Class:<br/>Send RPC_REQUEST]
        S4_3[Server:<br/>Receive request]
        S4_4[RPC Registry:<br/>Find handler ✓]
        S4_5[RPC Handler:<br/>Validate with<br/>Pydantic]
        S4_6{Valid?}
        S4_7[Server:<br/>ValidationError<br/>missing 'a' and 'b']
        S4_8[Server:<br/>Create Error<br/>validation details]
        S4_9[Server:<br/>RPC_ERROR]
        S4_10[Client App:<br/>Raise RPCError<br/>with details ✗]
        
        S4_1 --> S4_2 --> S4_3 --> S4_4 --> S4_5 --> S4_6
        S4_6 -->|No| S4_7 --> S4_8 --> S4_9 --> S4_10
    end
    
    style S1_7 fill:#90EE90
    style S2_16 fill:#90EE90
    style S3_9 fill:#FFB6B6
    style S4_10 fill:#FFB6B6
    style S2_9 fill:#FFE4B5
    style S3_5 fill:#FFE4B5
    style S4_6 fill:#FFE4B5
```

## RPC Components

### Client-Side
- **RPC Class** - Handles RPC calls, correlation IDs, response parsing
- **data() helper** - Builds parameter dictionary
- **Auto-parsing** - Deserializes responses to Pydantic models

### Server-Side
- **RPC Registry** - Stores method → handler mappings
- **RPC Dispatcher** - Routes requests to handlers
- **RPC Discovery** - Built-in "listall" method
- **Response/Error wrappers** - Clean result formatting

## Correlation IDs

Each RPC request gets a unique correlation ID to match requests with responses:
- Generated by client
- Included in request
- Server echoes it back in response
- Client matches response to waiting request
